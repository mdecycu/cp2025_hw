<!DOCTYPE html><html>
        <head>
        <title>cp2025_hw</title>
        <meta charset="utf-8">
<meta property="head" content="H3">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <link rel="stylesheet" href="./../cmsimde/static/chimper/fonts/icomoon/style.css">
        <link rel="stylesheet" href="./../cmsimde/static/chimper/css/bootstrap.min.css">
        <link rel="stylesheet" href="./../cmsimde/static/chimper/css/magnific-popup.css">
        <link rel="stylesheet" href="./../cmsimde/static/chimper/css/jquery-ui.css">
        <link rel="stylesheet" href="./../cmsimde/static/chimper/css/owl.carousel.min.css">
        <link rel="stylesheet" href="./../cmsimde/static/chimper/css/owl.theme.default.min.css">
        <link rel="stylesheet" href="./../cmsimde/static/chimper/css/bootstrap-datepicker.css">
        <link rel="stylesheet" href="./../cmsimde/static/chimper/fonts/flaticon/font/flaticon.css">
        <link rel="stylesheet" href="./../cmsimde/static/chimper/css/aos.css">
        <link rel="stylesheet" href="./../cmsimde/static/chimper/css/style.css">
        <link rel="shortcut icon" href="./../cmsimde/static/favicons.png">
        
        <style type='text/css'>
            .site-section {
            background-color: #FFFF;
            padding: 40px 40px;
            }
            body > div > div.dropdown.open {
                display: block;
            }
        </style>
    
        <!-- <script src="./../cmsimde/static/jquery.js"></script> -->
        <!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script> -->
        <script src="../cmsimde/static/chimper/js/jquery-3.3.1.min.js"></script>
        <link rel="stylesheet" href="./../cmsimde/static/tipuesearch/css/normalize.min.css">
        <script src="./../cmsimde/static/tipuesearch/tipuesearch_set.js"></script>
        <script src="tipuesearch_content.js"></script>
        <link rel="stylesheet" href="./../cmsimde/static/tipuesearch/css/tipuesearch.css">
        <script src="./../cmsimde/static/tipuesearch/tipuesearch.js"></script>
        <!-- for Wink3 å®¢è£½åŒ–é—œé–‰ -->
        <!--
        <link rel="stylesheet" type="text/css" href="./../cmsimde/static/winkPlayer.css" />
        <script type="text/javascript" src="./../cmsimde/static/winkPlayer.js"></script>
        -->
        <script>
            /* original tipuesearch
            $(document).ready(function() {
                 $('#tipue_search_input').tipuesearch();
            });
            */
            // customed doSearch
            function doSearch() {
                $('#tipue_search_input').tipuesearch({
                    newWindow: true, 
                    minimumLength: 2,
                    wholeWords: false, // for search ä¸­æ–‡
                });
            }
            $(document).ready(doSearch);
        </script>
        
<script type="text/javascript" src="./../cmsimde/static/syntaxhighlighter/shCore.js"></script>
<script type="text/javascript" src="./../cmsimde/static/syntaxhighlighter/shBrushBash.js"></script>
<script type="text/javascript" src="./../cmsimde/static/syntaxhighlighter/shBrushDiff.js"></script>
<script type="text/javascript" src="./../cmsimde/static/syntaxhighlighter/shBrushJScript.js"></script>
<script type="text/javascript" src="./../cmsimde/static/syntaxhighlighter/shBrushJava.js"></script>
<script type="text/javascript" src="./../cmsimde/static/syntaxhighlighter/shBrushPython.js"></script>
<script type="text/javascript" src="./../cmsimde/static/syntaxhighlighter/shBrushSql.js"></script>
<script type="text/javascript" src="./../cmsimde/static/syntaxhighlighter/shBrushHaxe.js"></script>
<script type="text/javascript" src="./../cmsimde/static/syntaxhighlighter/shBrushXml.js"></script>
<script type="text/javascript" src="./../cmsimde/static/syntaxhighlighter/shBrushPhp.js"></script>
<script type="text/javascript" src="./../cmsimde/static/syntaxhighlighter/shBrushPowerShell.js"></script>
<script type="text/javascript" src="./../cmsimde/static/syntaxhighlighter/shBrushLua.js"></script>
<script type="text/javascript" src="./../cmsimde/static/syntaxhighlighter/shBrushMojo.js"></script>
<script type="text/javascript" src="./../cmsimde/static/syntaxhighlighter/shBrushWbt.js"></script>
<script type="text/javascript" src="./../cmsimde/static/syntaxhighlighter/shBrushCpp.js"></script>
<script type="text/javascript" src="./../cmsimde/static/syntaxhighlighter/shBrushCss.js"></script>
<script type="text/javascript" src="./../cmsimde/static/syntaxhighlighter/shBrushCSharp.js"></script>
<script type="text/javascript" src="./../cmsimde/static/syntaxhighlighter/shBrushDart.js"></script>
<script type="text/javascript" src="./../cmsimde/static/syntaxhighlighter/shBrushRust.js"></script>
<link type="text/css" rel="stylesheet" href="./../cmsimde/static/syntaxhighlighter/css/shCoreDefault.css"/>
<script type="text/javascript">SyntaxHighlighter.all();</script>
<!-- æš«æ™‚ä¸ç”¨
<script src="./../cmsimde/static/fengari-web.js"></script>
<script type="text/javascript" src="./../cmsimde/static/Cango-13v08-min.js"></script>
<script type="text/javascript" src="./../cmsimde/static/CangoAxes-4v01-min.js"></script>
<script type="text/javascript" src="./../cmsimde/static/gearUtils-05.js"></script>
-->
<!-- for Brython æš«æ™‚ä¸ç”¨
<script src="https://scrum-3.github.io/web/brython/brython.js"></script>
<script src="https://scrum-3.github.io/web/brython/brython_stdlib.js"></script>
-->
<style>
img.add_border {
    border: 3px solid blue;
}
</style>

</head>
<body>
<div class='container'><nav>
        
    <div class="site-wrap">

    <div class="site-mobile-menu">
      <div class="site-mobile-menu-header">
        <div class="site-mobile-menu-close mt-3">
          <span class="icon-close2 js-menu-toggle"></span>
        </div>
      </div>
      <div class="site-mobile-menu-body"></div>
    </div>
    
            <header class="site-navbar py-4 bg-white" role="banner">
              <div class="container">
                <div class="row align-items-center">
                <h1>cp2025_hw </h1>
                <div class="pl-4">
                    <form>
                    <input type="text" placeholder="Search" name="q" id="tipue_search_input" pattern=".{2,}" title="At least 2 characters" required>
                    </form>
                </div>
                  <!-- <div class="col-11 col-xl-2">
                    <h1 class="mb-0 site-logo"><a href="index.html" class="text-black h2 mb-0">cp2025_hw </a></h1> 
                  </div>
                  -->
                  <div class="col-12 col-md-10 d-none d-xl-block">
                    <nav class="site-navigation position-relative text-right" role="navigation">
    <ul class='site-menu js-clone-nav mr-auto d-none d-lg-block'>
                        <li class="active has-children"><a href="index.html">Home</a>
                        <ul class="dropdown">
                            <li><a href="sitemap.html">SMap</a></li>
                            <li><a href="./../reveal/index.html">reveal</a></li>
                            <li><a href="./../blog/index.html">blog</a></li>
                        </ul>
                      </li>
                     <li><a href='About.html'>About</a><li class='has-children'><a href='Homework.html'>Homework</a><ul class='dropdown'><li><a href='HW0.html'>HW0</a><li><a href='HW1.html'>HW1</a><li><a href='HW2.html'>HW2</a><li><a href='HW3.html'>HW3</a><li><a href='HW4.html'>HW4</a></li></ul><li class='has-children'><a href='Brython.html'>Brython</a><ul class='dropdown'><li><a href='Brython_ex.html'>Brython_ex</a></li></ul><li class='has-children'><a href='Ref.html'>Ref</a><ul class='dropdown'><li class='has-children'><a href='Reeborg.html'>Reeborg</a><ul class='dropdown'><li><a href='ex1.html'>ex1</a><li><a href='Otto_ninja.html'>Otto_ninja</a></li></ul><li><a href='Pyodide.html'>Pyodide</a><li><a href='Pyodide_ex.html'>Pyodide_ex</a><li class='has-children'><a href='Pyodide2.html'>Pyodide2</a><ul class='dropdown'><li><a href='robot.py.html'>robot.py</a><li><a href='Example2.html'>Example2</a></li></ul><li class='has-children'><a href='Pyodide3.html'>Pyodide3</a><ul class='dropdown'><li><a href='png_files.html'>png_files</a><li><a href='Harvest.html'>Harvest</a></li>
                      </ul>
                </nav>
              </div>
              <div class="d-inline-block d-xl-none ml-md-0 mr-auto py-3" style="position: relative; top: 3px;"><a href="#" class="site-menu-toggle js-menu-toggle text-black"><span class="icon-menu h3"></span></a></div>
              </div>

            </div>
          </div>
          
        </header>
    <div id="tipue_search_content">Pyodide2 << <a href='Pyodide2.html'>Previous</a> <a href='Example2.html'>Next</a> >> Example2<br /><h1>robot.py</h1>
<p><a href="https://gist.githubusercontent.com/mdecycu/ec4bb35dd0769e7a83d2a9fa57878a67/raw/ff833d14181c7e270d37432aa8589f5ecf00e383/robot.py">robot.py</a></p>
<p>ç¬¬ä¸€æ®µï¼šæ¨¡çµ„åŒ¯å…¥èˆ‡å¸¸æ•¸å®šç¾©</p>
<p>js æ˜¯ Brython æä¾›çš„ JS-Python æ©‹æ¥æ¨¡çµ„ï¼Œå¯ç›´æ¥æ“ä½œ JavaScript DOMã€‚<br/><br/>asyncio æ˜¯ Python çš„éåŒæ­¥è™•ç†æ¨¡çµ„ï¼Œç”¨ä¾†è®“å‹•ç•«éåŒæ­¥é€²è¡Œã€‚<br/><br/>CELL_SIZE è¨­å®šåœ°åœ–ä¸­æ¯å€‹æ ¼å­çš„å¤§å°ï¼ˆ40px Ã— 40pxï¼‰ã€‚<br/><br/>WALL_THICKNESS æ˜¯ç”¨æ–¼ç¹ªè£½ç‰†å£çš„ç·šæ¢åšåº¦ã€‚<br/><br/>IMG_PATH æ˜¯å„²å­˜æ‰€æœ‰åœ–ç‰‡çš„ä¼ºæœå™¨è·¯å¾‘ï¼ˆç”¨æ–¼è¼‰å…¥ç‰†å£èˆ‡æ©Ÿå™¨äººåœ–ï¼‰ã€‚</p>
<pre class="brush:py;auto-links:false;toolbar:false" contenteditable="false">import js, asyncio

# æ¯å€‹æ ¼å­çš„åƒç´ å¯¬åº¦
CELL_SIZE = 40

# ç‰†å£çš„åšåº¦ï¼ˆåƒç´ ï¼‰
WALL_THICKNESS = 6

# åœ–ç‰‡è³‡æºçš„ç¶²å€å‰ç¶´
IMG_PATH = "https://mde.tw/cp2025/reeborg/src/images/"
</pre>
<p>ç¬¬äºŒæ®µï¼šWorld é¡åˆ¥ â€“ å»ºç«‹ä¸–ç•Œèˆ‡åœ°åœ–åœ–å±¤</p>
<p>World é¡è² è²¬å»ºç«‹æ•´å€‹åœ°åœ–ç•«é¢ï¼Œä¸¦åˆå§‹åŒ–æ‰€éœ€çš„ç•«å¸ƒåœ–å±¤ã€‚<br/><br/>_image_cache æ˜¯é¡åˆ¥å±¤ç´šè®Šæ•¸ï¼Œç”¨ä¾†å¿«å–åœ–ç‰‡ç‰©ä»¶ã€‚</p>
<pre class="brush:py;auto-links:false;toolbar:false" contenteditable="false">class World:
    _image_cache = {}  # ç”¨ä¾†æš«å­˜è¼‰å…¥éçš„åœ–ç‰‡ï¼Œé¿å…é‡è¤‡ä¸‹è¼‰

    def __init__(self, width, height):
        self.width = width     # åœ°åœ–å¯¬ï¼ˆå¹¾æ ¼ï¼‰
        self.height = height   # åœ°åœ–é«˜ï¼ˆå¹¾æ ¼ï¼‰
        self.layers = self._create_layers()  # å»ºç«‹å››å€‹ canvas åœ–å±¤
        self._init_html()      # å°‡åœ–å±¤èˆ‡æ§åˆ¶æŒ‰éˆ•åŠ åˆ° HTML ç•«é¢
</pre>
<p>ç¬¬ä¸‰æ®µï¼šå»ºç«‹åœ–å±¤</p>
<p>é€™äº›åœ–å±¤éƒ½æ˜¯ canvas å…ƒç´ ï¼Œå½¼æ­¤é‡ç–Šåœ¨ä¸€èµ·ï¼Œä¾åºç¹ªè£½åœ°åœ–ã€‚</p>
<pre class="brush:py;auto-links:false;toolbar:false" contenteditable="false">    def _create_layers(self):
        return {
            "grid": js.document.createElement("canvas"),    # ç¶²æ ¼åº•åœ–
            "walls": js.document.createElement("canvas"),   # ç‰†å£
            "objects": js.document.createElement("canvas"), # ç—•è·¡/ç‰©ä»¶
            "robots": js.document.createElement("canvas"),  # æ©Ÿå™¨äºº
        }
</pre>
<p>ç¬¬å››æ®µï¼šåˆå§‹åŒ– HTML çµæ§‹</p>
<p>å»ºç«‹ä¸€å€‹ container å®¹å™¨ï¼Œè¨­å®šç‚ºç›¸å°å®šä½ã€‚<br/><br/>å°‡å››å±¤ canvas ç–Šæ”¾é€²å®¹å™¨ä¸­ï¼Œæ¯å±¤ç”¨ä¸åŒçš„ zIndex ç–Šå±¤æ’åºã€‚</p>
<pre class="brush:py;auto-links:false;toolbar:false" contenteditable="false">    def _init_html(self):
        container = js.document.createElement("div")
        container.style.position = "relative"
        container.style.width = f"{self.width * CELL_SIZE}px"
        container.style.height = f"{self.height * CELL_SIZE}px"

        for z, canvas in enumerate(self.layers.values()):
            canvas.width = self.width * CELL_SIZE
            canvas.height = self.height * CELL_SIZE
            canvas.style.position = "absolute"
            canvas.style.top = "0px"
            canvas.style.left = "0px"
            canvas.style.zIndex = str(z)
            container.appendChild(canvas)
</pre>
<p>ç¬¬äº”æ®µï¼šå»ºç«‹æ§åˆ¶æŒ‰éˆ•ä¸¦åŠ å…¥ç•«é¢</p>
<p>å»ºç«‹å…©å€‹æŒ‰éˆ•ï¼šã€Œå‰é€²ã€èˆ‡ã€Œå·¦è½‰ã€ã€‚<br/><br/>è¨­å®šç¾è§€çš„æ¨£å¼ï¼ˆå…§é‚Šè·ã€å­—é«”å¤§å°ç­‰ï¼‰ã€‚</p>
<pre class="brush:py;auto-links:false;toolbar:false" contenteditable="false">        button_container = js.document.createElement("div")
        button_container.style.marginTop = "10px"
        button_container.style.textAlign = "center"

        move_button = js.document.createElement("button")
        move_button.innerHTML = "Move Forward"
        move_button.style.margin = "5px"
        move_button.style.padding = "10px 20px"
        move_button.style.fontSize = "16px"
        button_container.appendChild(move_button)

        turn_button = js.document.createElement("button")
        turn_button.innerHTML = "Turn Left"
        turn_button.style.margin = "5px"
        turn_button.style.padding = "10px 20px"
        turn_button.style.fontSize = "16px"
        button_container.appendChild(turn_button)
</pre>
<p>Â ç¬¬å…­æ®µï¼šæ›è¼‰é€² HTML èˆ‡æŒ‰éˆ•ç¶å®š</p>
<p>å°‡ç•«é¢æ›è¼‰åˆ° HTML ä¸­çš„ brython_div1 å…ƒç´ å…§ã€‚<br/><br/>åŒæ™‚è¨˜éŒ„å…©å€‹æŒ‰éˆ•åˆ° self.move_buttonã€self.turn_button å±¬æ€§ï¼Œä»¥ä¾¿ä¹‹å¾Œç¶å®šäº‹ä»¶</p>
<pre class="brush:py;auto-links:false;toolbar:false" contenteditable="false">        brython_div = js.document.getElementById("brython_div1")
        if not brython_div:
            raise RuntimeError("ğŸš¨ 'brython_div1' element not found in HTML!")
        brython_div.innerHTML = ""
        brython_div.appendChild(container)
        brython_div.appendChild(button_container)

        self.move_button = move_button
        self.turn_button = turn_button
</pre>
<p>ç¬¬ä¸ƒæ®µï¼šç¹ªè£½åœ°åœ–ç¶²æ ¼ç·šï¼ˆgridï¼‰</p>
<p>é€™æ®µç¨‹å¼æœƒç•«å‡ºåœ°åœ–çš„æ ¼ç·šï¼Œå½¢æˆæ£‹ç›¤ç‹€çš„ç¶²æ ¼ã€‚<br/><br/>æ¯æ ¼å¤§å°ç‚º CELL_SIZE = 40 åƒç´ ã€‚<br/><br/>æ ¼ç·šåªæ˜¯è¦–è¦ºè¼”åŠ©ï¼Œæ²’æœ‰ç¢°æ’ä½œç”¨ã€‚</p>
<pre class="brush:py;auto-links:false;toolbar:false" contenteditable="false">    def _draw_grid(self):
        ctx = self.layers["grid"].getContext("2d")  # å–å¾—ç¶²æ ¼åœ–å±¤çš„ç¹ªåœ–ä¸Šä¸‹æ–‡
        ctx.strokeStyle = "#cccccc"  # è¨­å®šç·šæ¢é¡è‰²ç‚ºæ·¡ç°è‰²

        # å‚ç›´ç·šï¼ˆæ¯åˆ—æ ¼ç·šï¼‰
        for i in range(self.width + 1):
            ctx.beginPath()
            ctx.moveTo(i * CELL_SIZE, 0)
            ctx.lineTo(i * CELL_SIZE, self.height * CELL_SIZE)
            ctx.stroke()

        # æ°´å¹³ç·šï¼ˆæ¯æ¬„æ ¼ç·šï¼‰
        for j in range(self.height + 1):
            ctx.beginPath()
            ctx.moveTo(0, j * CELL_SIZE)
            ctx.lineTo(self.width * CELL_SIZE, j * CELL_SIZE)
            ctx.stroke()
</pre>
<p>ç¬¬å…«æ®µï¼šé€šç”¨ç¹ªåœ–å‡½å¼ _draw_image()</p>
<p>æ­¤å‡½å¼è² è²¬ç•«åœ–ç‰‡åœ¨æŒ‡å®šæ ¼å­ä½ç½®ã€‚<br/><br/>éœ€è¦å‚³å…¥ï¼š<br/><br/>Â  Â  ctx: è¦ç¹ªè£½çš„ç•«å¸ƒä¸Šä¸‹æ–‡ã€‚<br/><br/>Â  Â  img_key: è¦ç•«çš„åœ–ç‰‡éµï¼ˆä¾‹å¦‚ "blue_robot_e"ï¼‰ã€‚<br/><br/>Â  Â  (x, y): è¦ç•«åœ¨å“ªå€‹æ ¼å­ï¼ˆä»¥åœ°åœ–é‚è¼¯åº§æ¨™ç‚ºä¸»ï¼‰ã€‚<br/><br/>Â  Â  (w, h): åœ–ç‰‡çš„å¯¬èˆ‡é«˜ã€‚<br/><br/>æœƒè‡ªå‹•èª¿æ•´ç•«é¢ä½ç½®ï¼Œå°‡ y è»¸ä¸Šä¸‹åè½‰ï¼Œä½¿åŸé»åœ¨å·¦ä¸‹è§’ã€‚</p>
<pre class="brush:py;auto-links:false;toolbar:false" contenteditable="false">    def _draw_image(self, ctx, img_key, x, y, w, h, offset_x=0, offset_y=0):
        img = World._image_cache.get(img_key)
        if img and img.complete and img.naturalWidth &gt; 0:
            px = x * CELL_SIZE + offset_x
            py = (self.height - 1 - y) * CELL_SIZE + offset_y
            ctx.drawImage(img, px, py, w, h)
            return True
        else:
            print(f"âš ï¸ Image '{img_key}' not ready for drawing.")
            return False
</pre>
<p>ç¬¬ä¹æ®µï¼šç¹ªè£½ç‰†å£ _draw_walls()</p>
<p>é€™æ®µæœƒå°‡å››å‘¨çš„ã€Œé‚Šç•Œç‰†ã€ç•«å‡ºä¾†ã€‚<br/><br/>åˆ©ç”¨ _draw_image ç•«å‡º north.png èˆ‡ east.pngã€‚<br/><br/>offset_x / offset_y ç”¨ä¾†å°é½Šåœ–ç‰‡ä½ç½®ï¼ˆä¸æœƒè“‹åˆ°æ ¼å­å…§ï¼‰ã€‚</p>
<pre class="brush:py;auto-links:false;toolbar:false" contenteditable="false">    async def _draw_walls(self):
        ctx = self.layers["walls"].getContext("2d")
        ctx.clearRect(0, 0, self.width * CELL_SIZE, self.height * CELL_SIZE)
        success = True

        # ç¹ªè£½ä¸Šä¸‹å…©æ’çš„åŒ—ç‰†ï¼ˆé ‚éƒ¨èˆ‡åº•éƒ¨ï¼‰
        for x in range(self.width):
            success &amp;= self._draw_image(ctx, "north", x, self.height - 1, CELL_SIZE, WALL_THICKNESS, offset_y=0)
            success &amp;= self._draw_image(ctx, "north", x, 0, CELL_SIZE, WALL_THICKNESS, offset_y=CELL_SIZE - WALL_THICKNESS)

        # ç¹ªè£½å·¦å³å…©å´çš„æ±ç‰†ï¼ˆå·¦é‚Šèˆ‡å³é‚Šï¼‰
        for y in range(self.height):
            success &amp;= self._draw_image(ctx, "east", 0, y, WALL_THICKNESS, CELL_SIZE, offset_x=0)
            success &amp;= self._draw_image(ctx, "east", self.width - 1, y, WALL_THICKNESS, CELL_SIZE, offset_x=CELL_SIZE - WALL_THICKNESS)

        return success
</pre>
<p>ç¬¬åæ®µï¼šé å…ˆè¼‰å…¥åœ–ç‰‡ _preload_images()</p>
<p>æ­¤å‡½å¼æœƒè¼‰å…¥æ‰€æœ‰éœ€è¦ç”¨åˆ°çš„åœ–ç‰‡ï¼ˆç‰†å£èˆ‡æ©Ÿå™¨äººæœå‘åœ–ï¼‰ã€‚<br/><br/>åˆ©ç”¨ Promise å»ºç«‹åœ–ç‰‡è¼‰å…¥å®Œæˆçš„éåŒæ­¥äº‹ä»¶ï¼Œç¢ºä¿è¼‰å…¥æˆåŠŸã€‚<br/><br/>é€é await js.await_promise(js.Promise.all(...)) ç­‰å¾…æ‰€æœ‰åœ–ç‰‡è¼‰å…¥å®Œç•¢ã€‚</p>
<pre class="brush:py;auto-links:false;toolbar:false" contenteditable="false">    async def _preload_images(self):
        image_files = {
            "blue_robot_e": "blue_robot_e.png",
            "blue_robot_n": "blue_robot_n.png",
            "blue_robot_w": "blue_robot_w.png",
            "blue_robot_s": "blue_robot_s.png",
            "north": "north.png",
            "east": "east.png",
        }

        promises = []
        for key, filename in image_files.items():
            if key in World._image_cache and World._image_cache[key].complete:
                continue

            img = js.document.createElement("img")
            img.crossOrigin = "Anonymous"
            img.src = IMG_PATH + filename
            World._image_cache[key] = img

            def make_promise(img_element):
                def executor(resolve, reject):
                    def on_load(event):
                        img_element.removeEventListener("load", on_load)
                        img_element.removeEventListener("error", on_error)
                        resolve(img_element)
                    def on_error(event):
                        img_element.removeEventListener("load", on_load)
                        img_element.removeEventListener("error", on_error)
                        reject(f"Failed to load image: {img_element.src}")
                    img_element.addEventListener("load", on_load)
                    img_element.addEventListener("error", on_error)
                    if img_element.complete and img_element.naturalWidth &gt; 0:
                        resolve(img_element)
                return js.Promise.new(executor)

            promises.append(make_promise(img))

        if not promises:
            return True
        try:
            await js.await_promise(js.Promise.all(promises))
            return True
        except Exception as e:
            print(f"ğŸš¨ Error during image preloading: {str(e)}")
            return False
</pre>
<p>ç¬¬åä¸€æ®µï¼šåˆå§‹åŒ–åœ°åœ–èˆ‡è³‡æº setup()</p>
<p>setup() æ˜¯å»ºæ§‹å®Œä¸–ç•Œå¾Œå¿…é ˆå‘¼å«çš„åˆå§‹åŒ–å‡½å¼ã€‚<br/><br/>åŒ…å«è³‡æºè¼‰å…¥ã€åœ°åœ–æ ¼ç·šèˆ‡ç‰†å£çš„ç¹ªè£½ã€‚<br/><br/>ä½¿ç”¨ asyncio.sleep(0) æ˜¯ä¸€ç¨®ã€Œè®“å‡ºä¸»æ§æ¬Šçµ¦ç€è¦½å™¨ã€çš„æŠ€å·§ï¼Œé¿å…å¡ä½ç•«é¢ã€‚</p>
<pre class="brush:py;auto-links:false;toolbar:false" contenteditable="false">    async def setup(self):
        # å˜—è©¦ä¸‰æ¬¡è¼‰å…¥åœ–ç‰‡è³‡æºï¼Œè‹¥è¼‰å…¥æˆåŠŸå‰‡è·³å‡ºè¿´åœˆ
        for _ in range(3):
            if await self._preload_images():
                break
            await asyncio.sleep(0.5)  # ç­‰å¾… 0.5 ç§’å¾Œå†è©¦
        else:
            print("ğŸš¨ Failed to preload images after retries.")
            return False

        await asyncio.sleep(0)  # æ”¾æ£„ç•¶å‰äº‹ä»¶è¿´åœˆåŸ·è¡Œæ¬Šï¼Œç¢ºä¿ UI æœ‰æ©Ÿæœƒæ›´æ–°

        self._draw_grid()  # ç¹ªè£½åº•å±¤çš„ç¶²æ ¼

        # å˜—è©¦ä¸‰æ¬¡ç¹ªè£½ç‰†å£ï¼Œç­‰å¾…åœ–ç‰‡è¼‰å…¥å®Œæˆ
        for _ in range(3):
            if await self._draw_walls():
                break
            await asyncio.sleep(0.5)
        else:
            print("ğŸš¨ Failed to draw walls after retries.")
            return False

        # æœ€å¾Œç¢ºèªæ©Ÿå™¨äººæœå‘æ±çš„åœ–ç‰‡æ˜¯å¦å¯ç”¨
        robot_img_key = "blue_robot_e"
        if not (World._image_cache.get(robot_img_key) and World._image_cache[robot_img_key].complete):
            print(f"ğŸš¨ Robot image '{robot_img_key}' still not ready after setup!")
            return False

        return True  # æ‰€æœ‰æ­¥é©ŸæˆåŠŸå¾Œå›å‚³ True
</pre>
<p>ç¬¬åäºŒæ®µï¼šæ©Ÿå™¨äººé¡åˆ¥ Robot</p>
<p>æ¯å€‹ Robot ç‰©ä»¶éƒ½æœ‰åº§æ¨™èˆ‡é¢å‘ï¼Œä¸¦èƒ½ç•«å‡ºè‡ªå·±èˆ‡ç§»å‹•çš„è»Œè·¡ã€‚<br/><br/>å‚³å…¥ world æ˜¯ç‚ºäº†èƒ½å–å¾—åœ°åœ–çš„ç•«å¸ƒè³‡è¨Šã€‚</p>
<pre class="brush:py;auto-links:false;toolbar:false" contenteditable="false">class Robot:
    def __init__(self, world, x, y):
        self.world = world
        self.x = x - 1  # å°‡äººé¡ç¿’æ…£çš„ 1-index è½‰æˆ 0-index
        self.y = y - 1
        self.facing = "E"  # é è¨­æœæ±ï¼ˆå³é‚Šï¼‰
        self._facing_order = ["E", "N", "W", "S"]  # å·¦è½‰æ™‚çš„é †åº

        self.robot_ctx = world.layers["robots"].getContext("2d")   # æ©Ÿå™¨äººåœ–å±¤
        self.trace_ctx = world.layers["objects"].getContext("2d")  # ç§»å‹•è»Œè·¡åœ–å±¤

        self._draw_robot()  # åˆå§‹ç•«ä¸Šæ©Ÿå™¨äºº
</pre>
<p>_robot_image_key()ï¼šä¾é¢å‘å›å‚³åœ–ç‰‡éµ</p>
<p>æ ¹æ“šé¢å‘å›å‚³å°æ‡‰çš„åœ–ç‰‡éµï¼Œä¾‹å¦‚ <code data-end="1939" data-start="1936">E</code> æœƒå›å‚³ <code data-end="1960" data-start="1944">"blue_robot_e"</code>ã€‚</p>
<pre class="brush:py;auto-links:false;toolbar:false" contenteditable="false">    def _robot_image_key(self):
        return f"blue_robot_{self.facing.lower()}"
</pre>
<p>_draw_robot()ï¼šç•«å‡ºæ©Ÿå™¨äººåœ–åƒ</p>
<p>å…ˆæ¸…é™¤åŸåœ–ï¼Œé¿å…ç•™ä¸‹æ®˜å½±ï¼Œå†ç•«ä¸Šæ–°çš„æ©Ÿå™¨äººåœ–åƒã€‚</p>
<pre class="brush:py;auto-links:false;toolbar:false" contenteditable="false">    def _draw_robot(self):
        self.robot_ctx.clearRect(0, 0, self.world.width * CELL_SIZE, self.world.height * CELL_SIZE)
        self.world._draw_image(self.robot_ctx, self._robot_image_key(), self.x, self.y, CELL_SIZE, CELL_SIZE)
</pre>
<p>_draw_trace()ï¼šç•«å‡ºç§»å‹•è·¯å¾‘</p>
<p>æ­¤æ–¹æ³•ç•«å‡ºæ©Ÿå™¨äººå¾èµ·é»åˆ°çµ‚é»çš„ç›´ç·šè»Œè·¡ã€‚</p>
<pre class="brush:py;auto-links:false;toolbar:false" contenteditable="false">    def _draw_trace(self, from_x, from_y, to_x, to_y):
        ctx = self.trace_ctx
        ctx.strokeStyle = "#d33"  # ç´…è‰²ç·šæ¢
        ctx.lineWidth = 2
        ctx.beginPath()
        fx = from_x * CELL_SIZE + CELL_SIZE / 2
        fy = (self.world.height - 1 - from_y) * CELL_SIZE + CELL_SIZE / 2
        tx = to_x * CELL_SIZE + CELL_SIZE / 2
        ty = (self.world.height - 1 - to_y) * CELL_SIZE + CELL_SIZE / 2
        ctx.moveTo(fx, fy)
        ctx.lineTo(tx, ty)
        ctx.stroke()
</pre>
<p>ç¬¬åä¸‰æ®µï¼šæ©Ÿå™¨äººè¡Œèµ°èˆ‡è½‰å½</p>
<p>walk(steps)ï¼šå‰é€²</p>
<p>æ ¹æ“šé¢å‘æ–¹å‘æ›´æ–°ä½ç½®ï¼Œä¸¦ç•«å‡ºç§»å‹•ã€‚<br/><br/>è¶…å‡ºåœ°åœ–é‚Šç•Œæ™‚åœæ­¢ã€‚</p>
<pre class="brush:py;auto-links:false;toolbar:false" contenteditable="false">    async def walk(self, steps=1):
        for _ in range(steps):
            from_x, from_y = self.x, self.y
            dx, dy = 0, 0
            if self.facing == "E": dx = 1
            elif self.facing == "W": dx = -1
            elif self.facing == "N": dy = 1
            elif self.facing == "S": dy = -1

            next_x = self.x + dx
            next_y = self.y + dy

            if 0 &lt;= next_x &lt; self.world.width and 0 &lt;= next_y &lt; self.world.height:
                self.x, self.y = next_x, next_y
                self._draw_trace(from_x, from_y, self.x, self.y)
                self._draw_robot()
                await asyncio.sleep(0.2)
            else:
                print("ğŸš¨ Hit a wall, stop moving!")
                break
</pre>
<p>turn_left()ï¼šå·¦è½‰</p>
<p>å¾ç›®å‰é¢å‘å‘å·¦è½‰ä¸€æ ¼ï¼Œæ›´æ–°åœ–ç‰‡ã€‚</p>
<pre class="brush:py;auto-links:false;toolbar:false" contenteditable="false">    async def turn_left(self):
        idx = self._facing_order.index(self.facing)
        self.facing = self._facing_order[(idx + 1) % 4]  # å¾ªç’°è½‰å‘
        self._draw_robot()
        await asyncio.sleep(0.3)
</pre>
<p>ç¬¬åå››æ®µï¼šç¶å®šæ§åˆ¶ _bind_controls(robot)</p>
<p>å®šç¾©ä¸€å€‹ç§æœ‰æ–¹æ³•ï¼Œå°‡æ§åˆ¶è¡Œç‚ºç¶å®šçµ¦ç‰¹å®š robot å¯¦ä¾‹ã€‚</p>
<pre class="brush:py;auto-links:false;toolbar:false" contenteditable="false">def _bind_controls(robot: Robot):
</pre>
<p>éµç›¤æ§åˆ¶</p>
<p>è¨­å®š j â†’ å‰é€²ï¼Œi â†’ å·¦è½‰ã€‚<br/><br/>ä½¿ç”¨ asyncio.create_task() ä»¥éåŒæ­¥æ–¹å¼åŸ·è¡Œï¼Œé¿å…å¡ä½ä¸»åŸ·è¡Œç·’ã€‚</p>
<pre class="brush:py;auto-links:false;toolbar:false" contenteditable="false">    def handle_key(event):
        try:
            if event.key == 'j':
                asyncio.create_task(robot.walk(1))     # æŒ‰ä¸‹ j ç§»å‹•ä¸€æ­¥
            elif event.key == 'i':
                asyncio.create_task(robot.turn_left()) # æŒ‰ä¸‹ i å·¦è½‰
        except Exception as e:
            print(f"ğŸš¨ Error in key handler: {e}")
</pre>
<p>æŒ‰éˆ•é»æ“Šæ§åˆ¶</p>
<p>é€™å…©å€‹å‡½å¼ç¶å®šåˆ° UI è£¡çš„æŒ‰éˆ•ï¼ˆå‰é¢ _init_html() ä¸­å®šç¾©çš„ï¼‰ã€‚<br/><br/>åŠŸèƒ½èˆ‡éµç›¤æ§åˆ¶ä¸€æ¨£ï¼Œåªæ˜¯é€éæ»‘é¼ é»æ“Šã€‚</p>
<pre class="brush:py;auto-links:false;toolbar:false" contenteditable="false">    def handle_move_button(event):
        try:
            asyncio.create_task(robot.walk(1))
        except Exception as e:
            print(f"ğŸš¨ Error in move button handler: {e}")

    def handle_turn_button(event):
        try:
            asyncio.create_task(robot.turn_left())
        except Exception as e:
            print(f"ğŸš¨ Error in turn button handler: {e}")
</pre>
<p>è¨»å†Šäº‹ä»¶åˆ° JavaScript</p>
<p>å°‡ handle_key() è¨»å†Šç‚ºå…¨åŸŸ py_handle_keyï¼Œè®“ JavaScript å±¤ç´šå¯ä»¥å‘¼å« Pythonã€‚</p>
<p>å°‡æŒ‰éˆ•çš„é»æ“Šäº‹ä»¶å°æ‡‰åˆ° Python å®šç¾©çš„æ§åˆ¶å‡½å¼ã€‚</p>
<pre class="brush:py;auto-links:false;toolbar:false" contenteditable="false">    js.window.py_handle_key = handle_key
    js.document.addEventListener('keydown', js.Function("event", "py_handle_key(event);"))
    js.window.py_handle_move_button = handle_move_button
    js.window.py_handle_turn_button = handle_turn_button
    robot.world.move_button.addEventListener('click', js.Function("event", "py_handle_move_button(event);"))
    robot.world.turn_button.addEventListener('click', js.Function("event", "py_handle_turn_button(event);"))</pre>
<p>ç¬¬åäº”æ®µï¼šåˆå§‹åŒ–ä¸¦å•Ÿå‹• init()</p>
<p>æä¾›ä¸€å€‹ä½¿ç”¨è€…ç°¡å–®å¿«é€Ÿåˆå§‹åŒ–æ•´å€‹ä¸–ç•Œèˆ‡æ©Ÿå™¨äººçš„ä»‹é¢ã€‚</p>
<pre class="brush:py;auto-links:false;toolbar:false" contenteditable="false">def init(world_width=10, world_height=10, robot_x=1, robot_y=1):
</pre>
<p>åŒ…è£ç‚ºéåŒæ­¥ä»»å‹™</p>
<p>é€™å€‹åŒ…è£å‡½å¼ async def _inner() æ˜¯ç”¨ä¾†å¯¦ä½œå…§éƒ¨éåŒæ­¥é‚è¼¯ã€‚</p>
<pre class="brush:py;auto-links:false;toolbar:false" contenteditable="false">    async def _inner():
        world = World(world_width, world_height)  # å»ºç«‹ä¸–ç•Œ
        if not await world.setup():               # ç­‰å¾…ä¸–ç•Œåˆå§‹åŒ–å®Œæˆ
            raise RuntimeError("World setup failed!")  # è‹¥å¤±æ•—å‰‡ä¸Ÿå‡ºéŒ¯èª¤

        robot = Robot(world, robot_x, robot_y)    # å»ºç«‹æ©Ÿå™¨äºº
        _bind_controls(robot)                     # ç¶å®šæ§åˆ¶äº‹ä»¶
        return world, robot                       # å‚³å› world å’Œ robot ç‰©ä»¶
</pre>
<p>å»ºç«‹ä¸¦å•Ÿå‹•éåŒæ­¥ä»»å‹™</p>
<pre class="brush:py;auto-links:false;toolbar:false" contenteditable="false">    return asyncio.create_task(_inner())
</pre>
<p>å›å‚³ä¸€å€‹éåŒæ­¥ä»»å‹™ï¼ˆasyncio.Taskï¼‰ï¼Œè®“ä½¿ç”¨è€…å¯ä»¥é€™æ¨£å‘¼å«ï¼š</p>
<pre class="brush:py;auto-links:false;toolbar:false" contenteditable="false">world, robot = await init(10, 10, 1, 1)
</pre>
<p>ç­‰å¾… init() çš„çµæœå¾Œï¼Œå°±å¯ä»¥ç›´æ¥æ§åˆ¶ robot.walk() æˆ– robot.turn_left()ã€‚</p>
<br />Pyodide2 << <a href='Pyodide2.html'>Previous</a> <a href='Example2.html'>Next</a> >> Example2</div>
        
    <!-- footer -->
      <div class="container">
        <div class="row pt-3 mx-auto">
            <p>
            <!-- Link back to Colorlib can't be removed. Template is licensed under CC BY 3.0. -->
            Copyright &copy;<script>document.write(new Date().getFullYear());</script> All rights reserved | This template is made with <i class="icon-heart" aria-hidden="true"></i> by <a href="https://colorlib.com" target="_blank" >Colorlib</a>
            <!-- Link back to Colorlib can't be removed. Template is licensed under CC BY 3.0. -->
            </p>
        </div>
      </div>
    <!-- for footer -->
    
        </div> <!-- for site wrap -->
            <!-- <script src="../cmsimde/static/chimper/js/jquery-3.3.1.min.js"></script> -->
            <script src="../cmsimde/static/chimper/js/jquery-migrate-3.0.1.min.js"></script>
            <script src="../cmsimde/static/chimper/js/jquery-ui.js"></script>
            <script src="../cmsimde/static/chimper/js/popper.min.js"></script>
            <script src="../cmsimde/static/chimper/js/bootstrap.min.js"></script>
            <script src="../cmsimde/static/chimper/js/owl.carousel.min.js"></script>
            <script src="../cmsimde/static/chimper/js/jquery.stellar.min.js"></script>
            <script src="../cmsimde/static/chimper/js/jquery.countdown.min.js"></script>
            <script src="../cmsimde/static/chimper/js/jquery.magnific-popup.min.js"></script>
            <script src="../cmsimde/static/chimper/js/bootstrap-datepicker.min.js"></script>
            <script src="../cmsimde/static/chimper/js/aos.js"></script>
            <!--
            <script src="../cmsimde/static/chimper/js/typed.js"></script>
                    <script>
                    var typed = new Typed('.typed-words', {
                    strings: ["Web Apps"," WordPress"," Mobile Apps"],
                    typeSpeed: 80,
                    backSpeed: 80,
                    backDelay: 4000,
                    startDelay: 1000,
                    loop: true,
                    showCursor: true
                    });
                    </script>
            -->
            <script src="../cmsimde/static/chimper/js/main.js"></script>
        
<!-- å•Ÿç”¨ LaTeX equations ç·¨è¼¯ -->
  <!-- <script>
  MathJax = {
    tex: {inlineMath: [['$', '$'], ['\(', '\)']]}
  };
  </script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>-->
    </body></html>
        