<!DOCTYPE html><html>
        <head>
        <title>cp2025_hw</title>
        <meta charset="utf-8">
<meta property="head" content="H3">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <link rel="stylesheet" href="./../cmsimde/static/chimper/fonts/icomoon/style.css">
        <link rel="stylesheet" href="./../cmsimde/static/chimper/css/bootstrap.min.css">
        <link rel="stylesheet" href="./../cmsimde/static/chimper/css/magnific-popup.css">
        <link rel="stylesheet" href="./../cmsimde/static/chimper/css/jquery-ui.css">
        <link rel="stylesheet" href="./../cmsimde/static/chimper/css/owl.carousel.min.css">
        <link rel="stylesheet" href="./../cmsimde/static/chimper/css/owl.theme.default.min.css">
        <link rel="stylesheet" href="./../cmsimde/static/chimper/css/bootstrap-datepicker.css">
        <link rel="stylesheet" href="./../cmsimde/static/chimper/fonts/flaticon/font/flaticon.css">
        <link rel="stylesheet" href="./../cmsimde/static/chimper/css/aos.css">
        <link rel="stylesheet" href="./../cmsimde/static/chimper/css/style.css">
        <link rel="shortcut icon" href="./../cmsimde/static/favicons.png">
        
        <style type='text/css'>
            .site-section {
            background-color: #FFFF;
            padding: 40px 40px;
            }
            body > div > div.dropdown.open {
                display: block;
            }
        </style>
    
        <!-- <script src="./../cmsimde/static/jquery.js"></script> -->
        <!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script> -->
        <script src="../cmsimde/static/chimper/js/jquery-3.3.1.min.js"></script>
        <link rel="stylesheet" href="./../cmsimde/static/tipuesearch/css/normalize.min.css">
        <script src="./../cmsimde/static/tipuesearch/tipuesearch_set.js"></script>
        <script src="tipuesearch_content.js"></script>
        <link rel="stylesheet" href="./../cmsimde/static/tipuesearch/css/tipuesearch.css">
        <script src="./../cmsimde/static/tipuesearch/tipuesearch.js"></script>
        <!-- for Wink3 客製化關閉 -->
        <!--
        <link rel="stylesheet" type="text/css" href="./../cmsimde/static/winkPlayer.css" />
        <script type="text/javascript" src="./../cmsimde/static/winkPlayer.js"></script>
        -->
        <script>
            /* original tipuesearch
            $(document).ready(function() {
                 $('#tipue_search_input').tipuesearch();
            });
            */
            // customed doSearch
            function doSearch() {
                $('#tipue_search_input').tipuesearch({
                    newWindow: true, 
                    minimumLength: 2,
                    wholeWords: false, // for search 中文
                });
            }
            $(document).ready(doSearch);
        </script>
        
<script type="text/javascript" src="./../cmsimde/static/syntaxhighlighter/shCore.js"></script>
<script type="text/javascript" src="./../cmsimde/static/syntaxhighlighter/shBrushBash.js"></script>
<script type="text/javascript" src="./../cmsimde/static/syntaxhighlighter/shBrushDiff.js"></script>
<script type="text/javascript" src="./../cmsimde/static/syntaxhighlighter/shBrushJScript.js"></script>
<script type="text/javascript" src="./../cmsimde/static/syntaxhighlighter/shBrushJava.js"></script>
<script type="text/javascript" src="./../cmsimde/static/syntaxhighlighter/shBrushPython.js"></script>
<script type="text/javascript" src="./../cmsimde/static/syntaxhighlighter/shBrushSql.js"></script>
<script type="text/javascript" src="./../cmsimde/static/syntaxhighlighter/shBrushHaxe.js"></script>
<script type="text/javascript" src="./../cmsimde/static/syntaxhighlighter/shBrushXml.js"></script>
<script type="text/javascript" src="./../cmsimde/static/syntaxhighlighter/shBrushPhp.js"></script>
<script type="text/javascript" src="./../cmsimde/static/syntaxhighlighter/shBrushPowerShell.js"></script>
<script type="text/javascript" src="./../cmsimde/static/syntaxhighlighter/shBrushLua.js"></script>
<script type="text/javascript" src="./../cmsimde/static/syntaxhighlighter/shBrushMojo.js"></script>
<script type="text/javascript" src="./../cmsimde/static/syntaxhighlighter/shBrushWbt.js"></script>
<script type="text/javascript" src="./../cmsimde/static/syntaxhighlighter/shBrushCpp.js"></script>
<script type="text/javascript" src="./../cmsimde/static/syntaxhighlighter/shBrushCss.js"></script>
<script type="text/javascript" src="./../cmsimde/static/syntaxhighlighter/shBrushCSharp.js"></script>
<script type="text/javascript" src="./../cmsimde/static/syntaxhighlighter/shBrushDart.js"></script>
<script type="text/javascript" src="./../cmsimde/static/syntaxhighlighter/shBrushRust.js"></script>
<link type="text/css" rel="stylesheet" href="./../cmsimde/static/syntaxhighlighter/css/shCoreDefault.css"/>
<script type="text/javascript">SyntaxHighlighter.all();</script>
<!-- 暫時不用
<script src="./../cmsimde/static/fengari-web.js"></script>
<script type="text/javascript" src="./../cmsimde/static/Cango-13v08-min.js"></script>
<script type="text/javascript" src="./../cmsimde/static/CangoAxes-4v01-min.js"></script>
<script type="text/javascript" src="./../cmsimde/static/gearUtils-05.js"></script>
-->
<!-- for Brython 暫時不用
<script src="https://scrum-3.github.io/web/brython/brython.js"></script>
<script src="https://scrum-3.github.io/web/brython/brython_stdlib.js"></script>
-->
<style>
img.add_border {
    border: 3px solid blue;
}
</style>

</head>
<body>
<div class='container'><nav>
        
    <div class="site-wrap">

    <div class="site-mobile-menu">
      <div class="site-mobile-menu-header">
        <div class="site-mobile-menu-close mt-3">
          <span class="icon-close2 js-menu-toggle"></span>
        </div>
      </div>
      <div class="site-mobile-menu-body"></div>
    </div>
    
            <header class="site-navbar py-4 bg-white" role="banner">
              <div class="container">
                <div class="row align-items-center">
                <h1>cp2025_hw </h1>
                <div class="pl-4">
                    <form>
                    <input type="text" placeholder="Search" name="q" id="tipue_search_input" pattern=".{2,}" title="At least 2 characters" required>
                    </form>
                </div>
                  <!-- <div class="col-11 col-xl-2">
                    <h1 class="mb-0 site-logo"><a href="index.html" class="text-black h2 mb-0">cp2025_hw </a></h1> 
                  </div>
                  -->
                  <div class="col-12 col-md-10 d-none d-xl-block">
                    <nav class="site-navigation position-relative text-right" role="navigation">
    <ul class='site-menu js-clone-nav mr-auto d-none d-lg-block'>
                        <li class="active has-children"><a href="index.html">Home</a>
                        <ul class="dropdown">
                            <li><a href="sitemap.html">SMap</a></li>
                            <li><a href="./../reveal/index.html">reveal</a></li>
                            <li><a href="./../blog/index.html">blog</a></li>
                        </ul>
                      </li>
                     <li><a href='About.html'>About</a><li class='has-children'><a href='Homework.html'>Homework</a><ul class='dropdown'><li><a href='HW0.html'>HW0</a><li><a href='HW1.html'>HW1</a><li><a href='HW2.html'>HW2</a><li><a href='HW3.html'>HW3</a><li><a href='HW4.html'>HW4</a></li></ul><li class='has-children'><a href='Brython.html'>Brython</a><ul class='dropdown'><li><a href='Brython_ex.html'>Brython_ex</a></li></ul><li class='has-children'><a href='Ref.html'>Ref</a><ul class='dropdown'><li class='has-children'><a href='Reeborg.html'>Reeborg</a><ul class='dropdown'><li><a href='ex1.html'>ex1</a><li><a href='Otto_ninja.html'>Otto_ninja</a></li></ul><li><a href='Pyodide.html'>Pyodide</a><li><a href='Pyodide_ex.html'>Pyodide_ex</a><li class='has-children'><a href='Pyodide2.html'>Pyodide2</a><ul class='dropdown'><li><a href='robot.py.html'>robot.py</a><li><a href='Example2.html'>Example2</a></li></ul><li class='has-children'><a href='Pyodide3.html'>Pyodide3</a><ul class='dropdown'><li><a href='png_files.html'>png_files</a><li><a href='Harvest.html'>Harvest</a></li>
                      </ul>
                </nav>
              </div>
              <div class="d-inline-block d-xl-none ml-md-0 mr-auto py-3" style="position: relative; top: 3px;"><a href="#" class="site-menu-toggle js-menu-toggle text-black"><span class="icon-menu h3"></span></a></div>
              </div>

            </div>
          </div>
          
        </header>
    <div id="tipue_search_content">Pyodide2 << <a href='Pyodide2.html'>Previous</a> <a href='Example2.html'>Next</a> >> Example2<br /><h1>robot.py</h1>
<p><a href="https://gist.githubusercontent.com/mdecycu/ec4bb35dd0769e7a83d2a9fa57878a67/raw/ff833d14181c7e270d37432aa8589f5ecf00e383/robot.py">robot.py</a></p>
<p>第一段：模組匯入與常數定義</p>
<p>js 是 Brython 提供的 JS-Python 橋接模組，可直接操作 JavaScript DOM。<br/><br/>asyncio 是 Python 的非同步處理模組，用來讓動畫非同步進行。<br/><br/>CELL_SIZE 設定地圖中每個格子的大小（40px × 40px）。<br/><br/>WALL_THICKNESS 是用於繪製牆壁的線條厚度。<br/><br/>IMG_PATH 是儲存所有圖片的伺服器路徑（用於載入牆壁與機器人圖）。</p>
<pre class="brush:py;auto-links:false;toolbar:false" contenteditable="false">import js, asyncio

# 每個格子的像素寬度
CELL_SIZE = 40

# 牆壁的厚度（像素）
WALL_THICKNESS = 6

# 圖片資源的網址前綴
IMG_PATH = "https://mde.tw/cp2025/reeborg/src/images/"
</pre>
<p>第二段：World 類別 – 建立世界與地圖圖層</p>
<p>World 類負責建立整個地圖畫面，並初始化所需的畫布圖層。<br/><br/>_image_cache 是類別層級變數，用來快取圖片物件。</p>
<pre class="brush:py;auto-links:false;toolbar:false" contenteditable="false">class World:
    _image_cache = {}  # 用來暫存載入過的圖片，避免重複下載

    def __init__(self, width, height):
        self.width = width     # 地圖寬（幾格）
        self.height = height   # 地圖高（幾格）
        self.layers = self._create_layers()  # 建立四個 canvas 圖層
        self._init_html()      # 將圖層與控制按鈕加到 HTML 畫面
</pre>
<p>第三段：建立圖層</p>
<p>這些圖層都是 canvas 元素，彼此重疊在一起，依序繪製地圖。</p>
<pre class="brush:py;auto-links:false;toolbar:false" contenteditable="false">    def _create_layers(self):
        return {
            "grid": js.document.createElement("canvas"),    # 網格底圖
            "walls": js.document.createElement("canvas"),   # 牆壁
            "objects": js.document.createElement("canvas"), # 痕跡/物件
            "robots": js.document.createElement("canvas"),  # 機器人
        }
</pre>
<p>第四段：初始化 HTML 結構</p>
<p>建立一個 container 容器，設定為相對定位。<br/><br/>將四層 canvas 疊放進容器中，每層用不同的 zIndex 疊層排序。</p>
<pre class="brush:py;auto-links:false;toolbar:false" contenteditable="false">    def _init_html(self):
        container = js.document.createElement("div")
        container.style.position = "relative"
        container.style.width = f"{self.width * CELL_SIZE}px"
        container.style.height = f"{self.height * CELL_SIZE}px"

        for z, canvas in enumerate(self.layers.values()):
            canvas.width = self.width * CELL_SIZE
            canvas.height = self.height * CELL_SIZE
            canvas.style.position = "absolute"
            canvas.style.top = "0px"
            canvas.style.left = "0px"
            canvas.style.zIndex = str(z)
            container.appendChild(canvas)
</pre>
<p>第五段：建立控制按鈕並加入畫面</p>
<p>建立兩個按鈕：「前進」與「左轉」。<br/><br/>設定美觀的樣式（內邊距、字體大小等）。</p>
<pre class="brush:py;auto-links:false;toolbar:false" contenteditable="false">        button_container = js.document.createElement("div")
        button_container.style.marginTop = "10px"
        button_container.style.textAlign = "center"

        move_button = js.document.createElement("button")
        move_button.innerHTML = "Move Forward"
        move_button.style.margin = "5px"
        move_button.style.padding = "10px 20px"
        move_button.style.fontSize = "16px"
        button_container.appendChild(move_button)

        turn_button = js.document.createElement("button")
        turn_button.innerHTML = "Turn Left"
        turn_button.style.margin = "5px"
        turn_button.style.padding = "10px 20px"
        turn_button.style.fontSize = "16px"
        button_container.appendChild(turn_button)
</pre>
<p> 第六段：掛載進 HTML 與按鈕綁定</p>
<p>將畫面掛載到 HTML 中的 brython_div1 元素內。<br/><br/>同時記錄兩個按鈕到 self.move_button、self.turn_button 屬性，以便之後綁定事件</p>
<pre class="brush:py;auto-links:false;toolbar:false" contenteditable="false">        brython_div = js.document.getElementById("brython_div1")
        if not brython_div:
            raise RuntimeError("🚨 'brython_div1' element not found in HTML!")
        brython_div.innerHTML = ""
        brython_div.appendChild(container)
        brython_div.appendChild(button_container)

        self.move_button = move_button
        self.turn_button = turn_button
</pre>
<p>第七段：繪製地圖網格線（grid）</p>
<p>這段程式會畫出地圖的格線，形成棋盤狀的網格。<br/><br/>每格大小為 CELL_SIZE = 40 像素。<br/><br/>格線只是視覺輔助，沒有碰撞作用。</p>
<pre class="brush:py;auto-links:false;toolbar:false" contenteditable="false">    def _draw_grid(self):
        ctx = self.layers["grid"].getContext("2d")  # 取得網格圖層的繪圖上下文
        ctx.strokeStyle = "#cccccc"  # 設定線條顏色為淡灰色

        # 垂直線（每列格線）
        for i in range(self.width + 1):
            ctx.beginPath()
            ctx.moveTo(i * CELL_SIZE, 0)
            ctx.lineTo(i * CELL_SIZE, self.height * CELL_SIZE)
            ctx.stroke()

        # 水平線（每欄格線）
        for j in range(self.height + 1):
            ctx.beginPath()
            ctx.moveTo(0, j * CELL_SIZE)
            ctx.lineTo(self.width * CELL_SIZE, j * CELL_SIZE)
            ctx.stroke()
</pre>
<p>第八段：通用繪圖函式 _draw_image()</p>
<p>此函式負責畫圖片在指定格子位置。<br/><br/>需要傳入：<br/><br/>    ctx: 要繪製的畫布上下文。<br/><br/>    img_key: 要畫的圖片鍵（例如 "blue_robot_e"）。<br/><br/>    (x, y): 要畫在哪個格子（以地圖邏輯座標為主）。<br/><br/>    (w, h): 圖片的寬與高。<br/><br/>會自動調整畫面位置，將 y 軸上下反轉，使原點在左下角。</p>
<pre class="brush:py;auto-links:false;toolbar:false" contenteditable="false">    def _draw_image(self, ctx, img_key, x, y, w, h, offset_x=0, offset_y=0):
        img = World._image_cache.get(img_key)
        if img and img.complete and img.naturalWidth &gt; 0:
            px = x * CELL_SIZE + offset_x
            py = (self.height - 1 - y) * CELL_SIZE + offset_y
            ctx.drawImage(img, px, py, w, h)
            return True
        else:
            print(f"⚠️ Image '{img_key}' not ready for drawing.")
            return False
</pre>
<p>第九段：繪製牆壁 _draw_walls()</p>
<p>這段會將四周的「邊界牆」畫出來。<br/><br/>利用 _draw_image 畫出 north.png 與 east.png。<br/><br/>offset_x / offset_y 用來對齊圖片位置（不會蓋到格子內）。</p>
<pre class="brush:py;auto-links:false;toolbar:false" contenteditable="false">    async def _draw_walls(self):
        ctx = self.layers["walls"].getContext("2d")
        ctx.clearRect(0, 0, self.width * CELL_SIZE, self.height * CELL_SIZE)
        success = True

        # 繪製上下兩排的北牆（頂部與底部）
        for x in range(self.width):
            success &amp;= self._draw_image(ctx, "north", x, self.height - 1, CELL_SIZE, WALL_THICKNESS, offset_y=0)
            success &amp;= self._draw_image(ctx, "north", x, 0, CELL_SIZE, WALL_THICKNESS, offset_y=CELL_SIZE - WALL_THICKNESS)

        # 繪製左右兩側的東牆（左邊與右邊）
        for y in range(self.height):
            success &amp;= self._draw_image(ctx, "east", 0, y, WALL_THICKNESS, CELL_SIZE, offset_x=0)
            success &amp;= self._draw_image(ctx, "east", self.width - 1, y, WALL_THICKNESS, CELL_SIZE, offset_x=CELL_SIZE - WALL_THICKNESS)

        return success
</pre>
<p>第十段：預先載入圖片 _preload_images()</p>
<p>此函式會載入所有需要用到的圖片（牆壁與機器人朝向圖）。<br/><br/>利用 Promise 建立圖片載入完成的非同步事件，確保載入成功。<br/><br/>透過 await js.await_promise(js.Promise.all(...)) 等待所有圖片載入完畢。</p>
<pre class="brush:py;auto-links:false;toolbar:false" contenteditable="false">    async def _preload_images(self):
        image_files = {
            "blue_robot_e": "blue_robot_e.png",
            "blue_robot_n": "blue_robot_n.png",
            "blue_robot_w": "blue_robot_w.png",
            "blue_robot_s": "blue_robot_s.png",
            "north": "north.png",
            "east": "east.png",
        }

        promises = []
        for key, filename in image_files.items():
            if key in World._image_cache and World._image_cache[key].complete:
                continue

            img = js.document.createElement("img")
            img.crossOrigin = "Anonymous"
            img.src = IMG_PATH + filename
            World._image_cache[key] = img

            def make_promise(img_element):
                def executor(resolve, reject):
                    def on_load(event):
                        img_element.removeEventListener("load", on_load)
                        img_element.removeEventListener("error", on_error)
                        resolve(img_element)
                    def on_error(event):
                        img_element.removeEventListener("load", on_load)
                        img_element.removeEventListener("error", on_error)
                        reject(f"Failed to load image: {img_element.src}")
                    img_element.addEventListener("load", on_load)
                    img_element.addEventListener("error", on_error)
                    if img_element.complete and img_element.naturalWidth &gt; 0:
                        resolve(img_element)
                return js.Promise.new(executor)

            promises.append(make_promise(img))

        if not promises:
            return True
        try:
            await js.await_promise(js.Promise.all(promises))
            return True
        except Exception as e:
            print(f"🚨 Error during image preloading: {str(e)}")
            return False
</pre>
<p>第十一段：初始化地圖與資源 setup()</p>
<p>setup() 是建構完世界後必須呼叫的初始化函式。<br/><br/>包含資源載入、地圖格線與牆壁的繪製。<br/><br/>使用 asyncio.sleep(0) 是一種「讓出主控權給瀏覽器」的技巧，避免卡住畫面。</p>
<pre class="brush:py;auto-links:false;toolbar:false" contenteditable="false">    async def setup(self):
        # 嘗試三次載入圖片資源，若載入成功則跳出迴圈
        for _ in range(3):
            if await self._preload_images():
                break
            await asyncio.sleep(0.5)  # 等待 0.5 秒後再試
        else:
            print("🚨 Failed to preload images after retries.")
            return False

        await asyncio.sleep(0)  # 放棄當前事件迴圈執行權，確保 UI 有機會更新

        self._draw_grid()  # 繪製底層的網格

        # 嘗試三次繪製牆壁，等待圖片載入完成
        for _ in range(3):
            if await self._draw_walls():
                break
            await asyncio.sleep(0.5)
        else:
            print("🚨 Failed to draw walls after retries.")
            return False

        # 最後確認機器人朝向東的圖片是否可用
        robot_img_key = "blue_robot_e"
        if not (World._image_cache.get(robot_img_key) and World._image_cache[robot_img_key].complete):
            print(f"🚨 Robot image '{robot_img_key}' still not ready after setup!")
            return False

        return True  # 所有步驟成功後回傳 True
</pre>
<p>第十二段：機器人類別 Robot</p>
<p>每個 Robot 物件都有座標與面向，並能畫出自己與移動的軌跡。<br/><br/>傳入 world 是為了能取得地圖的畫布資訊。</p>
<pre class="brush:py;auto-links:false;toolbar:false" contenteditable="false">class Robot:
    def __init__(self, world, x, y):
        self.world = world
        self.x = x - 1  # 將人類習慣的 1-index 轉成 0-index
        self.y = y - 1
        self.facing = "E"  # 預設朝東（右邊）
        self._facing_order = ["E", "N", "W", "S"]  # 左轉時的順序

        self.robot_ctx = world.layers["robots"].getContext("2d")   # 機器人圖層
        self.trace_ctx = world.layers["objects"].getContext("2d")  # 移動軌跡圖層

        self._draw_robot()  # 初始畫上機器人
</pre>
<p>_robot_image_key()：依面向回傳圖片鍵</p>
<p>根據面向回傳對應的圖片鍵，例如 <code data-end="1939" data-start="1936">E</code> 會回傳 <code data-end="1960" data-start="1944">"blue_robot_e"</code>。</p>
<pre class="brush:py;auto-links:false;toolbar:false" contenteditable="false">    def _robot_image_key(self):
        return f"blue_robot_{self.facing.lower()}"
</pre>
<p>_draw_robot()：畫出機器人圖像</p>
<p>先清除原圖，避免留下殘影，再畫上新的機器人圖像。</p>
<pre class="brush:py;auto-links:false;toolbar:false" contenteditable="false">    def _draw_robot(self):
        self.robot_ctx.clearRect(0, 0, self.world.width * CELL_SIZE, self.world.height * CELL_SIZE)
        self.world._draw_image(self.robot_ctx, self._robot_image_key(), self.x, self.y, CELL_SIZE, CELL_SIZE)
</pre>
<p>_draw_trace()：畫出移動路徑</p>
<p>此方法畫出機器人從起點到終點的直線軌跡。</p>
<pre class="brush:py;auto-links:false;toolbar:false" contenteditable="false">    def _draw_trace(self, from_x, from_y, to_x, to_y):
        ctx = self.trace_ctx
        ctx.strokeStyle = "#d33"  # 紅色線條
        ctx.lineWidth = 2
        ctx.beginPath()
        fx = from_x * CELL_SIZE + CELL_SIZE / 2
        fy = (self.world.height - 1 - from_y) * CELL_SIZE + CELL_SIZE / 2
        tx = to_x * CELL_SIZE + CELL_SIZE / 2
        ty = (self.world.height - 1 - to_y) * CELL_SIZE + CELL_SIZE / 2
        ctx.moveTo(fx, fy)
        ctx.lineTo(tx, ty)
        ctx.stroke()
</pre>
<p>第十三段：機器人行走與轉彎</p>
<p>walk(steps)：前進</p>
<p>根據面向方向更新位置，並畫出移動。<br/><br/>超出地圖邊界時停止。</p>
<pre class="brush:py;auto-links:false;toolbar:false" contenteditable="false">    async def walk(self, steps=1):
        for _ in range(steps):
            from_x, from_y = self.x, self.y
            dx, dy = 0, 0
            if self.facing == "E": dx = 1
            elif self.facing == "W": dx = -1
            elif self.facing == "N": dy = 1
            elif self.facing == "S": dy = -1

            next_x = self.x + dx
            next_y = self.y + dy

            if 0 &lt;= next_x &lt; self.world.width and 0 &lt;= next_y &lt; self.world.height:
                self.x, self.y = next_x, next_y
                self._draw_trace(from_x, from_y, self.x, self.y)
                self._draw_robot()
                await asyncio.sleep(0.2)
            else:
                print("🚨 Hit a wall, stop moving!")
                break
</pre>
<p>turn_left()：左轉</p>
<p>從目前面向向左轉一格，更新圖片。</p>
<pre class="brush:py;auto-links:false;toolbar:false" contenteditable="false">    async def turn_left(self):
        idx = self._facing_order.index(self.facing)
        self.facing = self._facing_order[(idx + 1) % 4]  # 循環轉向
        self._draw_robot()
        await asyncio.sleep(0.3)
</pre>
<p>第十四段：綁定控制 _bind_controls(robot)</p>
<p>定義一個私有方法，將控制行為綁定給特定 robot 實例。</p>
<pre class="brush:py;auto-links:false;toolbar:false" contenteditable="false">def _bind_controls(robot: Robot):
</pre>
<p>鍵盤控制</p>
<p>設定 j → 前進，i → 左轉。<br/><br/>使用 asyncio.create_task() 以非同步方式執行，避免卡住主執行緒。</p>
<pre class="brush:py;auto-links:false;toolbar:false" contenteditable="false">    def handle_key(event):
        try:
            if event.key == 'j':
                asyncio.create_task(robot.walk(1))     # 按下 j 移動一步
            elif event.key == 'i':
                asyncio.create_task(robot.turn_left()) # 按下 i 左轉
        except Exception as e:
            print(f"🚨 Error in key handler: {e}")
</pre>
<p>按鈕點擊控制</p>
<p>這兩個函式綁定到 UI 裡的按鈕（前面 _init_html() 中定義的）。<br/><br/>功能與鍵盤控制一樣，只是透過滑鼠點擊。</p>
<pre class="brush:py;auto-links:false;toolbar:false" contenteditable="false">    def handle_move_button(event):
        try:
            asyncio.create_task(robot.walk(1))
        except Exception as e:
            print(f"🚨 Error in move button handler: {e}")

    def handle_turn_button(event):
        try:
            asyncio.create_task(robot.turn_left())
        except Exception as e:
            print(f"🚨 Error in turn button handler: {e}")
</pre>
<p>註冊事件到 JavaScript</p>
<p>將 handle_key() 註冊為全域 py_handle_key，讓 JavaScript 層級可以呼叫 Python。</p>
<p>將按鈕的點擊事件對應到 Python 定義的控制函式。</p>
<pre class="brush:py;auto-links:false;toolbar:false" contenteditable="false">    js.window.py_handle_key = handle_key
    js.document.addEventListener('keydown', js.Function("event", "py_handle_key(event);"))
    js.window.py_handle_move_button = handle_move_button
    js.window.py_handle_turn_button = handle_turn_button
    robot.world.move_button.addEventListener('click', js.Function("event", "py_handle_move_button(event);"))
    robot.world.turn_button.addEventListener('click', js.Function("event", "py_handle_turn_button(event);"))</pre>
<p>第十五段：初始化並啟動 init()</p>
<p>提供一個使用者簡單快速初始化整個世界與機器人的介面。</p>
<pre class="brush:py;auto-links:false;toolbar:false" contenteditable="false">def init(world_width=10, world_height=10, robot_x=1, robot_y=1):
</pre>
<p>包裝為非同步任務</p>
<p>這個包裝函式 async def _inner() 是用來實作內部非同步邏輯。</p>
<pre class="brush:py;auto-links:false;toolbar:false" contenteditable="false">    async def _inner():
        world = World(world_width, world_height)  # 建立世界
        if not await world.setup():               # 等待世界初始化完成
            raise RuntimeError("World setup failed!")  # 若失敗則丟出錯誤

        robot = Robot(world, robot_x, robot_y)    # 建立機器人
        _bind_controls(robot)                     # 綁定控制事件
        return world, robot                       # 傳回 world 和 robot 物件
</pre>
<p>建立並啟動非同步任務</p>
<pre class="brush:py;auto-links:false;toolbar:false" contenteditable="false">    return asyncio.create_task(_inner())
</pre>
<p>回傳一個非同步任務（asyncio.Task），讓使用者可以這樣呼叫：</p>
<pre class="brush:py;auto-links:false;toolbar:false" contenteditable="false">world, robot = await init(10, 10, 1, 1)
</pre>
<p>等待 init() 的結果後，就可以直接控制 robot.walk() 或 robot.turn_left()。</p>
<br />Pyodide2 << <a href='Pyodide2.html'>Previous</a> <a href='Example2.html'>Next</a> >> Example2</div>
        
    <!-- footer -->
      <div class="container">
        <div class="row pt-3 mx-auto">
            <p>
            <!-- Link back to Colorlib can't be removed. Template is licensed under CC BY 3.0. -->
            Copyright &copy;<script>document.write(new Date().getFullYear());</script> All rights reserved | This template is made with <i class="icon-heart" aria-hidden="true"></i> by <a href="https://colorlib.com" target="_blank" >Colorlib</a>
            <!-- Link back to Colorlib can't be removed. Template is licensed under CC BY 3.0. -->
            </p>
        </div>
      </div>
    <!-- for footer -->
    
        </div> <!-- for site wrap -->
            <!-- <script src="../cmsimde/static/chimper/js/jquery-3.3.1.min.js"></script> -->
            <script src="../cmsimde/static/chimper/js/jquery-migrate-3.0.1.min.js"></script>
            <script src="../cmsimde/static/chimper/js/jquery-ui.js"></script>
            <script src="../cmsimde/static/chimper/js/popper.min.js"></script>
            <script src="../cmsimde/static/chimper/js/bootstrap.min.js"></script>
            <script src="../cmsimde/static/chimper/js/owl.carousel.min.js"></script>
            <script src="../cmsimde/static/chimper/js/jquery.stellar.min.js"></script>
            <script src="../cmsimde/static/chimper/js/jquery.countdown.min.js"></script>
            <script src="../cmsimde/static/chimper/js/jquery.magnific-popup.min.js"></script>
            <script src="../cmsimde/static/chimper/js/bootstrap-datepicker.min.js"></script>
            <script src="../cmsimde/static/chimper/js/aos.js"></script>
            <!--
            <script src="../cmsimde/static/chimper/js/typed.js"></script>
                    <script>
                    var typed = new Typed('.typed-words', {
                    strings: ["Web Apps"," WordPress"," Mobile Apps"],
                    typeSpeed: 80,
                    backSpeed: 80,
                    backDelay: 4000,
                    startDelay: 1000,
                    loop: true,
                    showCursor: true
                    });
                    </script>
            -->
            <script src="../cmsimde/static/chimper/js/main.js"></script>
        
<!-- 啟用 LaTeX equations 編輯 -->
  <!-- <script>
  MathJax = {
    tex: {inlineMath: [['$', '$'], ['\(', '\)']]}
  };
  </script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>-->
    </body></html>
        